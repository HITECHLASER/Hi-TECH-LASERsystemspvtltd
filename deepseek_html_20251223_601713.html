<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stone Engraving Management System</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #dc143c;
            --primary-dark: #b01030;
            --primary-light: #ff3867;
            --secondary: #2c3e50;
            --secondary-light: #34495e;
            --accent: #3498db;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #495057;
            --text-dark: #212529;
            --text-light: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }
        
        body {
            background-color: var(--light-gray);
            color: var(--text-dark);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }
        
        /* Navigation Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--secondary) 0%, var(--secondary-light) 100%);
            color: white;
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .logo-container {
            padding: 25px 20px;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }
        
        .logo-subtitle {
            font-size: 0.85rem;
            color: #bdc3c7;
            opacity: 0.9;
        }
        
        .nav-menu {
            list-style: none;
            padding: 20px 0;
        }
        
        .nav-item {
            margin: 5px 15px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.3);
        }
        
        .nav-link.active:hover {
            background-color: var(--primary-dark);
        }
        
        .nav-icon {
            margin-right: 15px;
            font-size: 1.3rem;
            width: 24px;
            text-align: center;
        }
        
        .nav-text {
            font-size: 1rem;
            font-weight: 500;
        }
        
        .nav-divider {
            height: 1px;
            background-color: rgba(255, 255, 255, 0.1);
            margin: 20px 15px;
        }
        
        .connection-status {
            padding: 15px 20px;
            margin: 20px 15px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            font-size: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-online {
            color: #2ecc71;
        }
        
        .status-offline {
            color: #e74c3c;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 0;
            background-color: var(--light-gray);
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        /* Top Header */
        .top-header {
            background-color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 3px solid var(--primary);
        }
        
        .page-title {
            color: var(--secondary);
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .page-subtitle {
            color: var(--text-light);
            font-size: 0.95rem;
            margin-top: 5px;
        }
        
        .datetime-container {
            background-color: var(--light-gray);
            padding: 12px 25px;
            border-radius: 8px;
            border: 2px solid var(--medium-gray);
            text-align: center;
            min-width: 220px;
        }
        
        .current-date {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 3px;
        }
        
        .current-time {
            font-size: 0.95rem;
            color: var(--text-light);
            font-weight: 500;
        }
        
        /* Content Container */
        .content-container {
            padding: 25px 30px;
            min-height: calc(100vh - 90px);
        }
        
        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .content-section.active {
            display: block;
        }
        
        /* Card Styles */
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            border-top: 4px solid var(--primary);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-size: 1.8rem;
            background-color: rgba(220, 20, 60, 0.1);
            color: var(--primary);
        }
        
        .card-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 5px;
        }
        
        .card-description {
            color: var(--text-light);
            font-size: 1rem;
        }
        
        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border-left: 5px solid var(--primary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-icon {
            width: 55px;
            height: 55px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.6rem;
        }
        
        .stat-icon.profit {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .stat-icon.works {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--accent);
        }
        
        .stat-icon.pending {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }
        
        .stat-icon.retailers {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        .stat-title {
            font-size: 0.95rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--secondary);
            margin: 5px 0;
        }
        
        .stat-change {
            font-size: 0.9rem;
            margin-top: 5px;
            font-weight: 500;
        }
        
        .positive {
            color: var(--success);
        }
        
        .negative {
            color: var(--danger);
        }
        
        /* Best Retailer Section */
        .best-retailer-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 15px;
            padding: 35px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(220, 20, 60, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .best-retailer-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(100px, -100px);
        }
        
        .retailer-badge {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 25px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .retailer-info {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .retailer-avatar {
            width: 90px;
            height: 90px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 3rem;
            font-weight: 800;
            margin-right: 30px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .retailer-details h3 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 800;
        }
        
        .retailer-details p {
            opacity: 0.9;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .retailer-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .retailer-stat {
            text-align: center;
        }
        
        .retailer-stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 8px;
        }
        
        .retailer-stat-label {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--secondary);
            font-size: 1.05rem;
        }
        
        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-col {
            flex: 1;
        }
        
        /* Button Styles */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(220, 20, 60, 0.3);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-3px);
        }
        
        .btn-secondary {
            background-color: var(--text-light);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-3px);
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-3px);
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-top: 20px;
        }
        
        .data-table th {
            background-color: var(--light-gray);
            padding: 18px 20px;
            text-align: left;
            font-weight: 700;
            color: var(--secondary);
            border-bottom: 3px solid var(--medium-gray);
            font-size: 1rem;
        }
        
        .data-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--medium-gray);
            color: var(--dark-gray);
        }
        
        .data-table tr:hover {
            background-color: rgba(220, 20, 60, 0.05);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending {
            background-color: rgba(255, 193, 7, 0.2);
            color: #d39e00;
        }
        
        .status-completed {
            background-color: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        /* Size Options */
        .size-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .size-option {
            border: 2px solid var(--medium-gray);
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
            text-align: center;
        }
        
        .size-option:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(220, 20, 60, 0.1);
        }
        
        .size-option.selected {
            border-color: var(--primary);
            background-color: rgba(220, 20, 60, 0.05);
            box-shadow: 0 5px 15px rgba(220, 20, 60, 0.15);
        }
        
        /* Notification */
        .notification {
            padding: 18px 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: none;
            border-left: 5px solid;
            font-weight: 500;
        }
        
        .notification-success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border-left-color: var(--success);
        }
        
        .notification-error {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border-left-color: var(--danger);
        }
        
        .notification-info {
            background-color: rgba(23, 162, 184, 0.1);
            color: var(--info);
            border-left-color: var(--info);
        }
        
        /* Firebase Settings */
        .firebase-settings {
            background-color: var(--light-gray);
            border-radius: 12px;
            padding: 30px;
            margin-top: 20px;
            border: 2px dashed var(--medium-gray);
        }
        
        .firebase-status {
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 25px;
            font-weight: 600;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .firebase-connected {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        .firebase-disconnected {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border: 2px solid var(--danger);
        }
        
        /* Phone Numbers */
        .phone-input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .phone-list {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid var(--medium-gray);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
            background-color: white;
        }
        
        .phone-item {
            padding: 15px;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .phone-item:hover {
            background-color: var(--light-gray);
        }
        
        .phone-item:last-child {
            border-bottom: none;
        }
        
        /* Recent Activity */
        .recent-activity-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .recent-activity-table th {
            background-color: var(--light-gray);
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--secondary);
            border-bottom: 2px solid var(--medium-gray);
        }
        
        .recent-activity-table td {
            padding: 15px 20px;
            border-bottom: 1px solid var(--medium-gray);
            color: var(--dark-gray);
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                width: 80px;
            }
            
            .main-content {
                margin-left: 80px;
            }
            
            .logo, .logo-subtitle, .nav-text, .connection-status span:not(:first-child) {
                display: none;
            }
            
            .nav-link {
                justify-content: center;
                padding: 15px 10px;
            }
            
            .nav-icon {
                margin-right: 0;
                font-size: 1.6rem;
            }
            
            .connection-status {
                padding: 10px;
                text-align: center;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: fixed;
                bottom: 0;
                top: auto;
                z-index: 1000;
            }
            
            .main-content {
                margin-left: 0;
                margin-bottom: 80px;
            }
            
            .nav-menu {
                display: flex;
                overflow-x: auto;
                padding: 10px;
            }
            
            .nav-item {
                flex: 1;
                min-width: 70px;
            }
            
            .nav-divider, .logo-container, .connection-status {
                display: none;
            }
            
            .top-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .datetime-container {
                width: 100%;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .retailer-info {
                flex-direction: column;
                text-align: center;
            }
            
            .retailer-avatar {
                margin-right: 0;
                margin-bottom: 20px;
            }
            
            .retailer-stats {
                grid-template-columns: 1fr;
            }
            
            .size-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Sidebar -->
    <nav class="sidebar">
        <div class="logo-container">
            <div class="logo">Stone Engraving</div>
            <div class="logo-subtitle">Professional Management System</div>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link active" data-section="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-section="add-work">
                    <span class="nav-icon">‚ûï</span>
                    <span class="nav-text">Add Work</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-section="view-works">
                    <span class="nav-icon">üìã</span>
                    <span class="nav-text">View Works</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-section="manage-retailers">
                    <span class="nav-icon">üè¢</span>
                    <span class="nav-text">Retailers</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-section="send-bills">
                    <span class="nav-icon">üí¨</span>
                    <span class="nav-text">Send Bills</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-section="phone-numbers">
                    <span class="nav-icon">üìû</span>
                    <span class="nav-text">Phone Numbers</span>
                </a>
            </li>
            <li class="nav-divider"></li>
            <li class="nav-item">
                <a class="nav-link" data-section="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">Settings</span>
                </a>
            </li>
        </ul>
        
        <div class="connection-status">
            <div>Status: <span id="connection-status" class="status-offline">Offline</span></div>
            <div id="storage-mode">Storage: Local</div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- Top Header -->
        <div class="top-header">
            <div>
                <div class="page-title">Dashboard Overview</div>
                <div class="page-subtitle" id="page-subtitle">Welcome to Stone Engraving Management System</div>
            </div>
            <div class="datetime-container">
                <div id="current-date" class="current-date">Loading...</div>
                <div id="current-time" class="current-time">Loading...</div>
            </div>
        </div>

        <!-- Content Container -->
        <div class="content-container">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon profit">üí∞</div>
                            <div>
                                <div class="stat-title">Monthly Profit</div>
                                <div class="stat-value" id="monthly-profit">$0.00</div>
                                <div class="stat-change positive" id="profit-change">+0% from last month</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon works">üìä</div>
                            <div>
                                <div class="stat-title">Monthly Works</div>
                                <div class="stat-value" id="monthly-works">0</div>
                                <div class="stat-change positive" id="works-change">+0% from last month</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon pending">‚è≥</div>
                            <div>
                                <div class="stat-title">Pending Bills</div>
                                <div class="stat-value" id="pending-bills">0</div>
                                <div class="stat-change negative" id="bills-change">0 pending</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon retailers">üë•</div>
                            <div>
                                <div class="stat-title">Active Retailers</div>
                                <div class="stat-value" id="active-retailers">0</div>
                                <div class="stat-change positive" id="retailers-change">+0% from last month</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Best Retailer Section -->
                <div class="best-retailer-section">
                    <div class="retailer-badge">üèÜ BEST RETAILER OF THE MONTH</div>
                    <div class="retailer-info">
                        <div class="retailer-avatar" id="best-retailer-avatar">?</div>
                        <div class="retailer-details">
                            <h3 id="best-retailer-name">Loading...</h3>
                            <p id="best-retailer-contact">Contact: Loading...</p>
                            <p id="best-retailer-stats">Total Business: $0 | Works: 0</p>
                        </div>
                    </div>
                    <div class="retailer-stats">
                        <div class="retailer-stat">
                            <div class="retailer-stat-value" id="stat-total">$0</div>
                            <div class="retailer-stat-label">Total Business</div>
                        </div>
                        <div class="retailer-stat">
                            <div class="retailer-stat-value" id="stat-works">0</div>
                            <div class="retailer-stat-label">Works Completed</div>
                        </div>
                        <div class="retailer-stat">
                            <div class="retailer-stat-value" id="stat-avg">$0</div>
                            <div class="retailer-stat-label">Average per Work</div>
                        </div>
                        <div class="retailer-stat">
                            <div class="retailer-stat-value" id="stat-pending">0</div>
                            <div class="retailer-stat-label">Pending Bills</div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üìà</div>
                        <div>
                            <div class="card-title">Recent Activity</div>
                            <div class="card-description">Latest work entries and transactions</div>
                        </div>
                    </div>
                    <table class="recent-activity-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Retailer</th>
                                <th>Customer</th>
                                <th>Size</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activity">
                            <tr><td colspan="6" style="text-align: center; padding: 40px;">Loading recent activity...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add Work Section -->
            <div id="add-work" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">‚ûï</div>
                        <div>
                            <div class="card-title">Add Daily Work</div>
                            <div class="card-description">Enter work details with date and time</div>
                        </div>
                    </div>
                    
                    <div id="notification-add" class="notification"></div>
                    
                    <form id="work-form">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="work-date">Date & Time *</label>
                                    <input type="datetime-local" id="work-date" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="retailer">Retailer *</label>
                                    <select id="retailer" class="form-control" required>
                                        <option value="">Select a retailer</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="customer-name">Customer Name *</label>
                                    <input type="text" id="customer-name" class="form-control" placeholder="Enter customer name" required>
                                </div>
                            </div>
                            
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="customer-phone">Customer Phone</label>
                                    <input type="tel" id="customer-phone" class="form-control" placeholder="Enter phone number">
                                </div>
                            </div>
                        </div>
                        
                        <div id="father-name-group" class="form-group" style="display: none;">
                            <label class="form-label" for="father-name">Father/Husband Name *</label>
                            <input type="text" id="father-name" class="form-control" placeholder="Required for duplicate products in same week">
                            <small style="color: var(--danger); font-size: 0.9rem;">This name is required because a product with the same customer name was entered this week.</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Select Size *</label>
                            <div class="size-options">
                                <div class="size-option" data-size="12x12">
                                    <div style="font-size: 1.3rem; font-weight: 700;">12x12</div>
                                    <div style="color: var(--text-light); font-size: 0.95rem;">Standard Size</div>
                                </div>
                                <div class="size-option" data-size="12x18">
                                    <div style="font-size: 1.3rem; font-weight: 700;">12x18</div>
                                    <div style="color: var(--text-light); font-size: 0.95rem;">Medium Size</div>
                                </div>
                                <div class="size-option" data-size="12x30">
                                    <div style="font-size: 1.3rem; font-weight: 700;">12x30</div>
                                    <div style="color: var(--text-light); font-size: 0.95rem;">Large Size</div>
                                </div>
                                <div class="size-option" data-size="12x30-kaman">
                                    <div style="font-size: 1.3rem; font-weight: 700;">12x30 Urdu Kaman</div>
                                    <div style="color: var(--text-light); font-size: 0.95rem;">Urdu Style</div>
                                </div>
                                <div class="size-option" data-size="12x24-kaman">
                                    <div style="font-size: 1.3rem; font-weight: 700;">12x24 Urdu Kaman</div>
                                    <div style="color: var(--text-light); font-size: 0.95rem;">Urdu Style</div>
                                </div>
                            </div>
                            <input type="hidden" id="selected-size" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Photo Option *</label>
                            <div style="display: flex; gap: 30px;">
                                <div>
                                    <input type="radio" id="with-photo" name="photo" value="with" checked>
                                    <label for="with-photo" style="margin-left: 8px; font-weight: 600;">With Photo</label>
                                </div>
                                <div>
                                    <input type="radio" id="without-photo" name="photo" value="without">
                                    <label for="without-photo" style="margin-left: 8px; font-weight: 600;">Without Photo</label>
                                </div>
                            </div>
                            <small id="photo-note" style="color: var(--text-light); display: block; margin-top: 5px;">Note: Urdu Kaman sizes do not have photo options</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="notes">Additional Notes</label>
                            <textarea id="notes" class="form-control" rows="3" placeholder="Any special instructions or details"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="price">Price (Based on retailer and size)</label>
                            <input type="number" id="price" class="form-control" readonly style="background-color: var(--light-gray); font-weight: 600;">
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button type="submit" class="btn btn-primary">
                                <span>üíæ</span> Add Work Entry
                            </button>
                            <button type="button" class="btn btn-secondary" id="clear-work-form">
                                <span>üîÑ</span> Clear Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- View Works Section -->
            <div id="view-works" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üìã</div>
                        <div>
                            <div class="card-title">View Works & Pending Bills</div>
                            <div class="card-description">Filter and manage all work entries</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="filter-retailer">Filter by Retailer</label>
                                <select id="filter-retailer" class="form-control">
                                    <option value="all">All Retailers</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="filter-status">Filter by Status</label>
                                <select id="filter-status" class="form-control">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Retailer</th>
                                <th>Customer Name</th>
                                <th>Size</th>
                                <th>Photo</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="works-table-body">
                            <tr><td colspan="8" style="text-align: center; padding: 40px;">Loading works...</td></tr>
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 25px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: 700; color: var(--secondary); font-size: 1.1rem;">
                            Total Works: <span id="total-works-count">0</span> | 
                            Total Amount: <span id="total-works-amount">$0.00</span>
                        </div>
                        <button class="btn btn-primary" id="export-works-pdf">
                            <span>üìÑ</span> Export to PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manage Retailers Section -->
            <div id="manage-retailers" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üè¢</div>
                        <div>
                            <div class="card-title">Manage Retailers & Pricing</div>
                            <div class="card-description">Add, edit, and configure retailer pricing</div>
                        </div>
                    </div>
                    
                    <div id="notification-retailer" class="notification"></div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <h3 style="margin-bottom: 20px; color: var(--secondary); font-size: 1.5rem;">Add/Edit Retailer</h3>
                            <form id="retailer-form">
                                <input type="hidden" id="retailer-id">
                                
                                <div class="form-group">
                                    <label class="form-label" for="retailer-name">Retailer Name *</label>
                                    <input type="text" id="retailer-name" class="form-control" placeholder="Enter retailer name" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="retailer-contact">Contact Number *</label>
                                    <input type="text" id="retailer-contact" class="form-control" placeholder="WhatsApp number with country code" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="retailer-email">Email Address</label>
                                    <input type="email" id="retailer-email" class="form-control" placeholder="Enter email">
                                </div>
                                
                                <h4 style="margin: 25px 0 15px 0; color: var(--secondary);">Pricing by Size</h4>
                                
                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label class="form-label" for="price-12x12">12x12 Price *</label>
                                            <input type="number" id="price-12x12" class="form-control" placeholder="Enter price" required min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label class="form-label" for="price-12x18">12x18 Price *</label>
                                            <input type="number" id="price-12x18" class="form-control" placeholder="Enter price" required min="0" step="0.01">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label class="form-label" for="price-12x30">12x30 Price *</label>
                                            <input type="number" id="price-12x30" class="form-control" placeholder="Enter price" required min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label class="form-label" for="price-12x30-kaman">12x30 Urdu Kaman *</label>
                                            <input type="number" id="price-12x30-kaman" class="form-control" placeholder="Enter price" required min="0" step="0.01">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label class="form-label" for="price-12x24-kaman">12x24 Urdu Kaman *</label>
                                            <input type="number" id="price-12x24-kaman" class="form-control" placeholder="Enter price" required min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="form-col"></div>
                                </div>
                                
                                <h4 style="margin: 25px 0 15px 0; color: var(--secondary);">Photo Options Pricing</h4>
                                
                                <div class="form-row">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label class="form-label" for="photo-with">Additional for Photo *</label>
                                            <input type="number" id="photo-with" class="form-control" placeholder="Additional cost for photo" required min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <label class="form-label" for="photo-without">Without Photo *</label>
                                            <input type="number" id="photo-without" class="form-control" placeholder="Cost without photo" required min="0" step="0.01">
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; margin-top: 30px;">
                                    <button type="submit" class="btn btn-primary" id="retailer-submit-btn">
                                        <span>‚ûï</span> Add Retailer
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="clear-retailer-form">
                                        <span>üîÑ</span> Clear Form
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="form-col">
                            <h3 style="margin-bottom: 20px; color: var(--secondary); font-size: 1.5rem;">Existing Retailers</h3>
                            <div id="retailer-list" style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                                <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
                                    Loading retailers...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Send Bills Section -->
            <div id="send-bills" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üí¨</div>
                        <div>
                            <div class="card-title">Send Bills via WhatsApp</div>
                            <div class="card-description">Generate and send pending bills to retailers</div>
                        </div>
                    </div>
                    
                    <div id="notification-whatsapp" class="notification"></div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="select-retailer-bills">Select Retailer</label>
                                <select id="select-retailer-bills" class="form-control">
                                    <option value="">Select a retailer</option>
                                </select>
                            </div>
                            
                            <div id="bills-summary" style="background-color: var(--light-gray); padding: 25px; border-radius: 12px; margin: 20px 0; border: 2px solid var(--medium-gray);">
                                <h4 style="color: var(--secondary); margin-bottom: 15px; font-size: 1.3rem;">Bill Summary</h4>
                                <p style="color: var(--text-light);">Select a retailer to view pending bills</p>
                            </div>
                            
                            <div class="form-group">
                                <button class="btn btn-success" id="send-whatsapp-bill" style="margin-right: 10px;">
                                    <span>üí¨</span> Send Bill via WhatsApp
                                </button>
                                <button class="btn btn-primary" id="mark-all-paid">
                                    <span>‚úÖ</span> Mark All as Paid
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-col">
                            <h3 style="margin-bottom: 15px; color: var(--secondary); font-size: 1.5rem;">WhatsApp Message Preview</h3>
                            <div style="background-color: #ece5dd; border-radius: 12px; padding: 25px; border-left: 5px solid #25d366;">
                                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                    <div style="color: #25d366; font-size: 28px; margin-right: 15px;">üí¨</div>
                                    <div>
                                        <div style="font-weight: 700; color: #333; font-size: 1.1rem;">Stone Engraving Co.</div>
                                        <small style="color: #666;">Just now</small>
                                    </div>
                                </div>
                                <div id="whatsapp-preview" style="background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-height: 250px; font-size: 1rem; line-height: 1.6;">
                                    Select a retailer to preview WhatsApp message
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 25px;">
                                <label class="form-label" for="custom-message">Customize Message (optional)</label>
                                <textarea id="custom-message" class="form-control" rows="4" placeholder="Add a custom note to your bill message..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Phone Numbers Section -->
            <div id="phone-numbers" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üìû</div>
                        <div>
                            <div class="card-title">Phone Numbers Management</div>
                            <div class="card-description">Store and manage phone numbers with PDF export</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 20px; color: var(--secondary); font-size: 1.5rem;">Add and Manage Phone Numbers</h3>
                    
                    <div class="phone-input-group">
                        <input type="tel" id="new-phone" class="form-control" placeholder="Enter phone number (e.g., +1234567890)">
                        <button type="button" class="btn btn-primary" id="add-phone-btn">
                            <span>‚ûï</span> Add Number
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="phone-category">Category</label>
                                <select id="phone-category" class="form-control">
                                    <option value="customer">Customer</option>
                                    <option value="retailer">Retailer</option>
                                    <option value="supplier">Supplier</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="phone-notes">Notes</label>
                                <input type="text" id="phone-notes" class="form-control" placeholder="Optional notes">
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="btn btn-success" id="export-all-phones">
                            <span>üìÑ</span> Export All Numbers as PDF
                        </button>
                        <button class="btn btn-primary" id="export-100-phones">
                            <span>üìã</span> Export Next 100 Numbers
                        </button>
                        <button class="btn btn-danger" id="clear-all-phones">
                            <span>üóëÔ∏è</span> Clear All
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="color: var(--secondary); font-size: 1.3rem;">Saved Phone Numbers (<span id="phone-count">0</span>)</h4>
                        <div id="export-status" style="color: var(--success); font-weight: 600; font-size: 1rem;"></div>
                    </div>
                    
                    <div class="phone-list" id="phone-numbers-list">
                        <!-- Phone numbers will be listed here -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; color: var(--text-light); font-size: 0.95rem;">
                        Numbers are saved automatically. Export PDFs for easy sharing.
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">‚öôÔ∏è</div>
                        <div>
                            <div class="card-title">System Settings</div>
                            <div class="card-description">Configure system preferences and Firebase connectivity</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 20px; color: var(--secondary); font-size: 1.5rem;">üõ† System Configuration</h3>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="system-name">System Name</label>
                                <input type="text" id="system-name" class="form-control" value="Stone Engraving Management System">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="currency-symbol">Currency Symbol</label>
                                <select id="currency-symbol" class="form-control">
                                    <option value="$">Dollar ($)</option>
                                    <option value="‚Ç¨">Euro (‚Ç¨)</option>
                                    <option value="¬£">Pound (¬£)</option>
                                    <option value="‚Çπ">Rupee (‚Çπ)</option>
                                    <option value="PKR">Pakistani Rupee (PKR)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="date-format">Date Format</label>
                                <select id="date-format" class="form-control">
                                    <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                    <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                                    <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="duplicate-days">Duplicate Check Days</label>
                                <input type="number" id="duplicate-days" class="form-control" value="7" min="1" max="30">
                                <small style="color: var(--text-light);">Number of days to check for duplicate customer names</small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button class="btn btn-primary" id="save-settings">
                            <span>üíæ</span> Save Settings
                        </button>
                    </div>
                </div>
                
                <!-- Firebase Connectivity -->
                <div class="card" style="margin-top: 25px;">
                    <h3 style="margin-bottom: 20px; color: var(--secondary); font-size: 1.5rem;">üî• Firebase Connectivity</h3>
                    
                    <div class="firebase-settings">
                        <div id="firebase-status" class="firebase-status firebase-disconnected">
                            üî¥ Firebase: Not Connected
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="firebase-api-key">API Key</label>
                            <input type="text" id="firebase-api-key" class="form-control" placeholder="Enter Firebase API Key">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="firebase-auth-domain">Auth Domain</label>
                            <input type="text" id="firebase-auth-domain" class="form-control" placeholder="Enter Firebase Auth Domain">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="firebase-project-id">Project ID</label>
                            <input type="text" id="firebase-project-id" class="form-control" placeholder="Enter Firebase Project ID">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="firebase-storage-bucket">Storage Bucket</label>
                            <input type="text" id="firebase-storage-bucket" class="form-control" placeholder="Enter Firebase Storage Bucket">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="firebase-messaging-sender-id">Messaging Sender ID</label>
                            <input type="text" id="firebase-messaging-sender-id" class="form-control" placeholder="Enter Firebase Messaging Sender ID">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="firebase-app-id">App ID</label>
                            <input type="text" id="firebase-app-id" class="form-control" placeholder="Enter Firebase App ID">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="firebase-measurement-id">Measurement ID (Optional)</label>
                            <input type="text" id="firebase-measurement-id" class="form-control" placeholder="Enter Firebase Measurement ID">
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                            <button class="btn btn-success" id="connect-firebase">
                                <span>üîó</span> Connect to Firebase
                            </button>
                            <button class="btn btn-secondary" id="test-firebase">
                                <span>üß™</span> Test Connection
                            </button>
                            <button class="btn btn-danger" id="disconnect-firebase">
                                <span>üî¥</span> Disconnect
                            </button>
                        </div>
                        
                        <div style="margin-top: 25px; padding: 20px; background-color: rgba(3, 102, 214, 0.05); border-radius: 10px; border-left: 4px solid #0366d6;">
                            <h4 style="color: #0366d6; margin-bottom: 10px; font-size: 1.2rem;">‚ÑπÔ∏è How to Get Firebase Credentials</h4>
                            <ol style="color: #586069; margin-left: 20px;">
                                <li>Go to <a href="https://console.firebase.google.com/" target="_blank" style="color: #0366d6;">Firebase Console</a></li>
                                <li>Create a new project or select existing one</li>
                                <li>Click "Add app" and select Web</li>
                                <li>Register your app and get the configuration</li>
                                <li>Enable Firestore Database in Build section</li>
                                <li>Copy the configuration values here</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="sync-to-firebase">
                            <span>üîÑ</span> Sync Data to Firebase
                        </button>
                        <button class="btn btn-success" id="sync-from-firebase">
                            <span>üì•</span> Sync Data from Firebase
                        </button>
                        <button class="btn btn-warning" id="export-all-data">
                            <span>üíæ</span> Export All Data
                        </button>
                        <button class="btn btn-danger" id="reset-system">
                            <span>‚ö†Ô∏è</span> Reset System
                        </button>
                    </div>
                    
                    <div style="margin-top: 30px; background-color: var(--light-gray); padding: 25px; border-radius: 12px;">
                        <h4 style="color: var(--secondary); margin-bottom: 15px; font-size: 1.3rem;">System Information</h4>
                        <div class="form-row">
                            <div class="form-col">
                                <p><strong>Version:</strong> 4.0.0</p>
                                <p><strong>Data Size:</strong> <span id="data-size">0 KB</span></p>
                            </div>
                            <div class="form-col">
                                <p><strong>Last Backup:</strong> <span id="last-backup">Never</span></p>
                                <p><strong>Storage Mode:</strong> <span id="storage-mode-display">Local Storage</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        let works = [];
        let retailers = [];
        let phoneNumbers = [];
        let systemSettings = {};
        let firebaseApp = null;
        let firebaseInitialized = false;
        let usingFirebase = false;
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initSystem();
            setupNavigation();
            setupEventListeners();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Set initial page title
            updatePageTitle('Dashboard Overview', 'Welcome to Stone Engraving Management System');
        });
        
        function initSystem() {
            // Load settings first
            loadSystemSettings();
            
            // Then load data based on storage mode
            if (usingFirebase && firebaseInitialized) {
                loadDataFromFirebase();
            } else {
                loadDataFromLocalStorage();
            }
            
            // Initialize UI
            updateRetailerDropdowns();
            loadDashboard();
            updateConnectionStatus();
        }
        
        function loadSystemSettings() {
            const savedSettings = localStorage.getItem('engraving-settings');
            if (savedSettings) {
                systemSettings = JSON.parse(savedSettings);
            } else {
                // Default settings
                systemSettings = {
                    systemName: "Stone Engraving Management System",
                    currencySymbol: "$",
                    dateFormat: "yyyy-mm-dd",
                    duplicateDays: 7,
                    autoBackup: "weekly",
                    lastBackup: null,
                    useFirebase: false,
                    firebaseConfig: null
                };
                saveSystemSettingsToStorage();
            }
            
            // Update UI
            document.getElementById('system-name').value = systemSettings.systemName;
            document.getElementById('currency-symbol').value = systemSettings.currencySymbol;
            document.getElementById('date-format').value = systemSettings.dateFormat;
            document.getElementById('duplicate-days').value = systemSettings.duplicateDays;
            
            // Load Firebase config if exists
            if (systemSettings.firebaseConfig) {
                document.getElementById('firebase-api-key').value = systemSettings.firebaseConfig.apiKey || '';
                document.getElementById('firebase-auth-domain').value = systemSettings.firebaseConfig.authDomain || '';
                document.getElementById('firebase-project-id').value = systemSettings.firebaseConfig.projectId || '';
                document.getElementById('firebase-storage-bucket').value = systemSettings.firebaseConfig.storageBucket || '';
                document.getElementById('firebase-messaging-sender-id').value = systemSettings.firebaseConfig.messagingSenderId || '';
                document.getElementById('firebase-app-id').value = systemSettings.firebaseConfig.appId || '';
                document.getElementById('firebase-measurement-id').value = systemSettings.firebaseConfig.measurementId || '';
                
                // Auto-connect if previously connected
                if (systemSettings.useFirebase) {
                    setTimeout(() => connectToFirebase(), 1000);
                }
            }
        }
        
        function loadDataFromLocalStorage() {
            // Load works
            const savedWorks = localStorage.getItem('engraving-works');
            works = savedWorks ? JSON.parse(savedWorks) : getSampleWorks();
            
            // Load retailers
            const savedRetailers = localStorage.getItem('engraving-retailers');
            retailers = savedRetailers ? JSON.parse(savedRetailers) : getSampleRetailers();
            
            // Load phone numbers
            const savedPhones = localStorage.getItem('engraving-phones');
            phoneNumbers = savedPhones ? JSON.parse(savedPhones) : getSamplePhoneNumbers();
            
            console.log('Data loaded from localStorage');
        }
        
        function loadDataFromFirebase() {
            // This will be implemented when Firebase is connected
            console.log('Loading data from Firebase...');
            // For now, fall back to localStorage
            loadDataFromLocalStorage();
        }
        
        function getSampleWorks() {
            const currentDate = new Date();
            const pastDate = new Date();
            pastDate.setDate(pastDate.getDate() - 5);
            
            return [
                {
                    id: 'work-' + Date.now(),
                    date: currentDate.toISOString().split('T')[0],
                    datetime: currentDate.toISOString(),
                    retailerId: 'retailer1',
                    customerName: 'John Smith',
                    customerPhone: '+12345678901',
                    fatherName: '',
                    size: '12x12',
                    photo: 'with',
                    notes: 'Black granite with gold engraving',
                    price: 65,
                    status: 'pending'
                },
                {
                    id: 'work-' + (Date.now() - 1000),
                    date: pastDate.toISOString().split('T')[0],
                    datetime: pastDate.toISOString(),
                    retailerId: 'retailer2',
                    customerName: 'Maria Garcia',
                    customerPhone: '+12345678902',
                    fatherName: '',
                    size: '12x30',
                    photo: 'without',
                    notes: 'White marble memorial',
                    price: 90,
                    status: 'completed'
                }
            ];
        }
        
        function getSampleRetailers() {
            return [
                {
                    id: 'retailer1',
                    name: 'Stone Art Emporium',
                    contact: '+1234567890',
                    email: 'contact@stoneart.com',
                    prices: {
                        '12x12': 45,
                        '12x18': 65,
                        '12x30': 85,
                        '12x30-kaman': 95,
                        '12x24-kaman': 75,
                        'photo-with': 20,
                        'photo-without': 0
                    }
                },
                {
                    id: 'retailer2',
                    name: 'Memorial Creations',
                    contact: '+1987654321',
                    email: 'info@memorialcreations.com',
                    prices: {
                        '12x12': 50,
                        '12x18': 70,
                        '12x30': 90,
                        '12x30-kaman': 100,
                        '12x24-kaman': 80,
                        'photo-with': 25,
                        'photo-without': 0
                    }
                }
            ];
        }
        
        function getSamplePhoneNumbers() {
            const numbers = [];
            for (let i = 1; i <= 150; i++) {
                numbers.push({
                    id: 'phone-' + i,
                    number: '+1234567' + (1000 + i).toString().substring(1),
                    category: i <= 50 ? 'customer' : i <= 100 ? 'retailer' : 'supplier',
                    notes: i <= 50 ? 'Sample Customer' : i <= 100 ? 'Sample Retailer' : 'Sample Supplier',
                    dateAdded: new Date().toISOString()
                });
            }
            return numbers;
        }
        
        // ==================== NAVIGATION ====================
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    
                    // Update active navigation
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show selected section
                    showSection(sectionId);
                    
                    // Update page title
                    updatePageTitleForSection(sectionId);
                });
            });
        }
        
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                
                // Load section-specific data
                switch(sectionId) {
                    case 'dashboard':
                        loadDashboard();
                        break;
                    case 'add-work':
                        initWorkForm();
                        break;
                    case 'view-works':
                        loadWorksTable();
                        break;
                    case 'manage-retailers':
                        loadRetailerList();
                        break;
                    case 'send-bills':
                        updateWhatsAppPreview();
                        break;
                    case 'phone-numbers':
                        loadPhoneNumbers();
                        break;
                    case 'settings':
                        updateSystemInfo();
                        break;
                }
            }
        }
        
        function updatePageTitle(title, subtitle) {
            document.querySelector('.page-title').textContent = title;
            document.querySelector('#page-subtitle').textContent = subtitle;
        }
        
        function updatePageTitleForSection(sectionId) {
            const titles = {
                'dashboard': ['Dashboard Overview', 'Welcome to Stone Engraving Management System'],
                'add-work': ['Add Daily Work', 'Enter work details with date and time'],
                'view-works': ['View Works & Pending Bills', 'Filter and manage all work entries'],
                'manage-retailers': ['Manage Retailers & Pricing', 'Add, edit, and configure retailer pricing'],
                'send-bills': ['Send Bills via WhatsApp', 'Generate and send pending bills to retailers'],
                'phone-numbers': ['Phone Numbers Management', 'Store and manage phone numbers with PDF export'],
                'settings': ['System Settings', 'Configure system preferences and Firebase connectivity']
            };
            
            if (titles[sectionId]) {
                updatePageTitle(titles[sectionId][0], titles[sectionId][1]);
            }
        }
        
        // ==================== DATE & TIME ====================
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour12: true, 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('current-date').textContent = dateStr;
            document.getElementById('current-time').textContent = timeStr;
        }
        
        // ==================== SAVE FUNCTIONS ====================
        function saveWorks() {
            localStorage.setItem('engraving-works', JSON.stringify(works));
            if (usingFirebase && firebaseInitialized) {
                saveToFirebase('works', works);
            }
        }
        
        function saveRetailers() {
            localStorage.setItem('engraving-retailers', JSON.stringify(retailers));
            if (usingFirebase && firebaseInitialized) {
                saveToFirebase('retailers', retailers);
            }
        }
        
        function savePhoneNumbers() {
            localStorage.setItem('engraving-phones', JSON.stringify(phoneNumbers));
            if (usingFirebase && firebaseInitialized) {
                saveToFirebase('phoneNumbers', phoneNumbers);
            }
        }
        
        function saveSystemSettingsToStorage() {
            localStorage.setItem('engraving-settings', JSON.stringify(systemSettings));
        }
        
        // ==================== FIREBASE FUNCTIONS ====================
        function connectToFirebase() {
            const config = {
                apiKey: document.getElementById('firebase-api-key').value,
                authDomain: document.getElementById('firebase-auth-domain').value,
                projectId: document.getElementById('firebase-project-id').value,
                storageBucket: document.getElementById('firebase-storage-bucket').value,
                messagingSenderId: document.getElementById('firebase-messaging-sender-id').value,
                appId: document.getElementById('firebase-app-id').value,
                measurementId: document.getElementById('firebase-measurement-id').value || ''
            };
            
            // Validate config
            if (!config.apiKey || !config.authDomain || !config.projectId) {
                showNotification('notification-add', 'Please fill all required Firebase fields', 'error');
                return;
            }
            
            try {
                // Initialize Firebase
                firebaseApp = firebase.initializeApp(config, 'stone-engraving-app');
                firebaseInitialized = true;
                usingFirebase = true;
                
                // Save config to settings
                systemSettings.firebaseConfig = config;
                systemSettings.useFirebase = true;
                saveSystemSettingsToStorage();
                
                // Update UI
                document.getElementById('firebase-status').className = 'firebase-status firebase-connected';
                document.getElementById('firebase-status').innerHTML = 'üü¢ Firebase: Connected Successfully';
                document.getElementById('connection-status').className = 'status-online';
                document.getElementById('connection-status').textContent = 'Online (Firebase)';
                document.getElementById('storage-mode').textContent = 'Storage: Firebase';
                document.getElementById('storage-mode-display').textContent = 'Firebase Cloud';
                
                showNotification('notification-add', 'Firebase connected successfully!', 'success');
                
                // Sync data to Firebase
                setTimeout(() => syncToFirebase(), 1000);
                
            } catch (error) {
                console.error('Firebase connection error:', error);
                showNotification('notification-add', 'Firebase connection failed: ' + error.message, 'error');
            }
        }
        
        function testFirebaseConnection() {
            if (!firebaseInitialized) {
                showNotification('notification-add', 'Firebase not connected. Please connect first.', 'error');
                return;
            }
            
            showNotification('notification-add', 'Testing Firebase connection...', 'info');
            
            // Try to write a test document
            const db = firebase.firestore();
            const testRef = db.collection('test').doc('connection-test');
            
            testRef.set({
                test: true,
                timestamp: new Date().toISOString()
            }).then(() => {
                showNotification('notification-add', 'Firebase connection test successful!', 'success');
                testRef.delete(); // Clean up test document
            }).catch(error => {
                showNotification('notification-add', 'Firebase test failed: ' + error.message, 'error');
            });
        }
        
        function disconnectFromFirebase() {
            if (firebaseApp) {
                try {
                    firebaseApp.delete();
                    firebaseApp = null;
                    firebaseInitialized = false;
                    usingFirebase = false;
                    
                    systemSettings.useFirebase = false;
                    saveSystemSettingsToStorage();
                    
                    document.getElementById('firebase-status').className = 'firebase-status firebase-disconnected';
                    document.getElementById('firebase-status').innerHTML = 'üî¥ Firebase: Not Connected';
                    document.getElementById('connection-status').className = 'status-offline';
                    document.getElementById('connection-status').textContent = 'Offline';
                    document.getElementById('storage-mode').textContent = 'Storage: Local';
                    document.getElementById('storage-mode-display').textContent = 'Local Storage';
                    
                    showNotification('notification-add', 'Disconnected from Firebase', 'info');
                    
                } catch (error) {
                    console.error('Firebase disconnect error:', error);
                }
            }
        }
        
        function saveToFirebase(collectionName, data) {
            if (!firebaseInitialized) return;
            
            const db = firebase.firestore();
            const batch = db.batch();
            
            // For simplicity, we'll store each collection as a single document
            const docRef = db.collection('systemData').doc(collectionName);
            batch.set(docRef, { data: data, updatedAt: new Date().toISOString() });
            
            batch.commit().then(() => {
                console.log(collectionName + ' saved to Firebase');
            }).catch(error => {
                console.error('Error saving to Firebase:', error);
            });
        }
        
        function syncToFirebase() {
            if (!firebaseInitialized) {
                showNotification('notification-add', 'Firebase not connected', 'error');
                return;
            }
            
            showNotification('notification-add', 'Syncing data to Firebase...', 'info');
            
            // Save all data to Firebase
            saveToFirebase('works', works);
            saveToFirebase('retailers', retailers);
            saveToFirebase('phoneNumbers', phoneNumbers);
            saveToFirebase('settings', systemSettings);
            
            setTimeout(() => {
                showNotification('notification-add', 'Data synced to Firebase successfully!', 'success');
            }, 1500);
        }
        
        function syncFromFirebase() {
            if (!firebaseInitialized) {
                showNotification('notification-add', 'Firebase not connected', 'error');
                return;
            }
            
            showNotification('notification-add', 'Syncing data from Firebase...', 'info');
            
            const db = firebase.firestore();
            const promises = [
                db.collection('systemData').doc('works').get(),
                db.collection('systemData').doc('retailers').get(),
                db.collection('systemData').doc('phoneNumbers').get(),
                db.collection('systemData').doc('settings').get()
            ];
            
            Promise.all(promises).then(snapshots => {
                snapshots.forEach((snapshot, index) => {
                    if (snapshot.exists) {
                        const data = snapshot.data();
                        switch(index) {
                            case 0: works = data.data || []; break;
                            case 1: retailers = data.data || []; break;
                            case 2: phoneNumbers = data.data || []; break;
                            case 3: 
                                systemSettings = data.data || systemSettings;
                                loadSystemSettings();
                                break;
                        }
                    }
                });
                
                // Save to localStorage as backup
                localStorage.setItem('engraving-works', JSON.stringify(works));
                localStorage.setItem('engraving-retailers', JSON.stringify(retailers));
                localStorage.setItem('engraving-phones', JSON.stringify(phoneNumbers));
                localStorage.setItem('engraving-settings', JSON.stringify(systemSettings));
                
                // Update UI
                updateRetailerDropdowns();
                loadDashboard();
                if (document.getElementById('view-works').classList.contains('active')) {
                    loadWorksTable();
                }
                if (document.getElementById('phone-numbers').classList.contains('active')) {
                    loadPhoneNumbers();
                }
                
                showNotification('notification-add', 'Data synced from Firebase successfully!', 'success');
                
            }).catch(error => {
                showNotification('notification-add', 'Sync failed: ' + error.message, 'error');
            });
        }
        
        function updateConnectionStatus() {
            if (usingFirebase && firebaseInitialized) {
                document.getElementById('connection-status').className = 'status-online';
                document.getElementById('connection-status').textContent = 'Online (Firebase)';
                document.getElementById('storage-mode').textContent = 'Storage: Firebase';
            } else {
                document.getElementById('connection-status').className = 'status-offline';
                document.getElementById('connection-status').textContent = 'Offline';
                document.getElementById('storage-mode').textContent = 'Storage: Local';
            }
        }
        
        // ==================== UI FUNCTIONS ====================
        function showNotification(elementId, message, type) {
            const notification = document.getElementById(elementId);
            if (!notification) return;
            
            notification.textContent = message;
            notification.className = `notification notification-${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // ==================== DASHBOARD FUNCTIONS ====================
        function loadDashboard() {
            // Calculate monthly stats
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Monthly works and profit
            const monthlyWorks = works.filter(work => {
                const workDate = new Date(work.date);
                return workDate.getMonth() === currentMonth && 
                       workDate.getFullYear() === currentYear;
            });
            
            const monthlyProfit = monthlyWorks.reduce((sum, work) => sum + work.price, 0);
            document.getElementById('monthly-profit').textContent = 
                systemSettings.currencySymbol + monthlyProfit.toFixed(2);
            document.getElementById('monthly-works').textContent = monthlyWorks.length;
            
            // Pending bills
            const pendingWorks = works.filter(work => work.status === 'pending');
            document.getElementById('pending-bills').textContent = pendingWorks.length;
            
            // Active retailers
            document.getElementById('active-retailers').textContent = retailers.length;
            
            // Find best retailer
            findBestRetailer();
            
            // Load recent activity
            loadRecentActivity();
        }
        
        function findBestRetailer() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let bestRetailer = null;
            let maxBusiness = 0;
            
            retailers.forEach(retailer => {
                const retailerWorks = works.filter(work => {
                    const workDate = new Date(work.date);
                    return work.retailerId === retailer.id &&
                           workDate.getMonth() === currentMonth &&
                           workDate.getFullYear() === currentYear;
                });
                
                const totalBusiness = retailerWorks.reduce((sum, work) => sum + work.price, 0);
                const workCount = retailerWorks.length;
                const pendingCount = retailerWorks.filter(w => w.status === 'pending').length;
                const avgPrice = workCount > 0 ? totalBusiness / workCount : 0;
                
                if (totalBusiness > maxBusiness) {
                    maxBusiness = totalBusiness;
                    bestRetailer = {
                        ...retailer,
                        monthlyBusiness: totalBusiness,
                        workCount,
                        pendingCount,
                        avgPrice
                    };
                }
            });
            
            if (bestRetailer) {
                document.getElementById('best-retailer-name').textContent = bestRetailer.name;
                document.getElementById('best-retailer-contact').textContent = `Contact: ${bestRetailer.contact}`;
                document.getElementById('best-retailer-stats').textContent = 
                    `Total Business: ${systemSettings.currencySymbol}${bestRetailer.monthlyBusiness.toFixed(2)} | Works: ${bestRetailer.workCount}`;
                
                document.getElementById('best-retailer-avatar').textContent = bestRetailer.name.charAt(0).toUpperCase();
                
                document.getElementById('stat-total').textContent = systemSettings.currencySymbol + bestRetailer.monthlyBusiness.toFixed(0);
                document.getElementById('stat-works').textContent = bestRetailer.workCount;
                document.getElementById('stat-avg').textContent = systemSettings.currencySymbol + bestRetailer.avgPrice.toFixed(0);
                document.getElementById('stat-pending').textContent = bestRetailer.pendingCount;
            } else {
                document.getElementById('best-retailer-name').textContent = 'No data available';
                document.getElementById('best-retailer-contact').textContent = 'Select a month to view best performer';
                document.getElementById('best-retailer-stats').textContent = 'Total Business: $0.00 | Works: 0';
            }
        }
        
        function loadRecentActivity() {
            const tableBody = document.getElementById('recent-activity');
            tableBody.innerHTML = '';
            
            // Get recent works (last 5)
            const recentWorks = [...works]
                .sort((a, b) => new Date(b.datetime || b.date) - new Date(a.datetime || a.date))
                .slice(0, 5);
            
            if (recentWorks.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No recent activity</td></tr>';
                return;
            }
            
            recentWorks.forEach(work => {
                const retailer = retailers.find(r => r.id === work.retailerId);
                const retailerName = retailer ? retailer.name : 'Unknown';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(work.datetime || work.date)}</td>
                    <td>${retailerName}</td>
                    <td>${work.customerName}</td>
                    <td>${formatSizeName(work.size)}</td>
                    <td>${systemSettings.currencySymbol}${work.price.toFixed(2)}</td>
                    <td><span class="status-badge status-${work.status}">${work.status.charAt(0).toUpperCase() + work.status.slice(1)}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // ==================== ADD WORK FUNCTIONS ====================
        function initWorkForm() {
            // Set current datetime
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            document.getElementById('work-date').value = localDateTime;
            
            // Clear previous selections
            document.querySelectorAll('.size-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('selected-size').value = '';
            document.getElementById('price').value = '';
            document.getElementById('father-name-group').style.display = 'none';
            document.getElementById('with-photo').checked = true;
            document.getElementById('with-photo').disabled = false;
            document.getElementById('without-photo').disabled = false;
            document.getElementById('photo-note').style.color = 'var(--text-light)';
            
            // Update retailer dropdown
            updateRetailerDropdown('retailer');
            
            // Add click events to size options
            document.querySelectorAll('.size-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectSize(this);
                });
            });
        }
        
        function selectSize(element) {
            // Remove selected class from all
            document.querySelectorAll('.size-option').forEach(opt => opt.classList.remove('selected'));
            
            // Add to clicked element
            element.classList.add('selected');
            
            // Set hidden input
            const size = element.getAttribute('data-size');
            document.getElementById('selected-size').value = size;
            
            // Update price
            updatePrice();
            
            // Handle photo options for kaman sizes
            const photoNote = document.getElementById('photo-note');
            if (size.includes('kaman')) {
                document.getElementById('without-photo').checked = true;
                document.getElementById('with-photo').disabled = true;
                document.getElementById('without-photo').disabled = true;
                photoNote.style.color = 'var(--danger)';
            } else {
                document.getElementById('with-photo').disabled = false;
                document.getElementById('without-photo').disabled = false;
                photoNote.style.color = 'var(--text-light)';
            }
        }
        
        function updatePrice() {
            const retailerId = document.getElementById('retailer').value;
            const size = document.getElementById('selected-size').value;
            const photo = document.querySelector('input[name="photo"]:checked')?.value || 'with';
            
            if (!retailerId || !size) {
                document.getElementById('price').value = '';
                return;
            }
            
            const retailer = retailers.find(r => r.id === retailerId);
            if (!retailer || !retailer.prices) {
                document.getElementById('price').value = '';
                return;
            }
            
            let price = retailer.prices[size] || 0;
            if (photo === 'with' && !size.includes('kaman')) {
                price += retailer.prices['photo-with'] || 0;
            }
            
            document.getElementById('price').value = price.toFixed(2);
        }
        
        function checkDuplicateCustomer() {
            const customerName = document.getElementById('customer-name').value.trim().toLowerCase();
            if (!customerName) return false;
            
            const duplicateDays = parseInt(systemSettings.duplicateDays) || 7;
            const currentDate = new Date();
            const daysAgo = new Date(currentDate);
            daysAgo.setDate(daysAgo.getDate() - duplicateDays);
            
            const duplicate = works.find(work => {
                const workDate = new Date(work.date);
                return work.customerName.toLowerCase() === customerName && 
                       workDate >= daysAgo && 
                       workDate <= currentDate;
            });
            
            const fatherNameGroup = document.getElementById('father-name-group');
            if (duplicate) {
                fatherNameGroup.style.display = 'block';
                document.getElementById('father-name').required = true;
                return true;
            } else {
                fatherNameGroup.style.display = 'none';
                document.getElementById('father-name').required = false;
                return false;
            }
        }
        
        // ==================== VIEW WORKS FUNCTIONS ====================
        function loadWorksTable() {
            const filterRetailer = document.getElementById('filter-retailer').value;
            const filterStatus = document.getElementById('filter-status').value;
            
            // Update retailer filter dropdown
            updateRetailerDropdown('filter-retailer');
            
            let filteredWorks = [...works];
            
            // Apply filters
            if (filterRetailer !== 'all') {
                filteredWorks = filteredWorks.filter(work => work.retailerId === filterRetailer);
            }
            
            if (filterStatus !== 'all') {
                filteredWorks = filteredWorks.filter(work => work.status === filterStatus);
            }
            
            // Sort by date (newest first)
            filteredWorks.sort((a, b) => new Date(b.datetime || b.date) - new Date(a.datetime || a.date));
            
            // Populate table
            const tableBody = document.getElementById('works-table-body');
            tableBody.innerHTML = '';
            
            let totalAmount = 0;
            
            filteredWorks.forEach(work => {
                const retailer = retailers.find(r => r.id === work.retailerId);
                const retailerName = retailer ? retailer.name : 'Unknown';
                
                totalAmount += work.price;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(work.datetime || work.date)}</td>
                    <td>${retailerName}</td>
                    <td>${work.customerName}${work.fatherName ? ` (${work.fatherName})` : ''}</td>
                    <td>${formatSizeName(work.size)}</td>
                    <td>${work.photo === 'with' ? 'With Photo' : 'Without Photo'}</td>
                    <td>${systemSettings.currencySymbol}${work.price.toFixed(2)}</td>
                    <td><span class="status-badge status-${work.status}">${work.status.charAt(0).toUpperCase() + work.status.slice(1)}</span></td>
                    <td class="action-buttons">
                        <button class="action-btn btn-primary" onclick="editWork('${work.id}')">Edit</button>
                        <button class="action-btn btn-danger" onclick="deleteWork('${work.id}')">Delete</button>
                        <button class="action-btn ${work.status === 'pending' ? 'btn-success' : 'btn-secondary'}" onclick="toggleWorkStatus('${work.id}')">
                            ${work.status === 'pending' ? 'Mark Paid' : 'Mark Pending'}
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update totals
            document.getElementById('total-works-count').textContent = filteredWorks.length;
            document.getElementById('total-works-amount').textContent = 
                systemSettings.currencySymbol + totalAmount.toFixed(2);
            
            if (filteredWorks.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No works found</td></tr>';
            }
        }
        
        function filterWorks() {
            loadWorksTable();
        }
        
        function editWork(workId) {
            const work = works.find(w => w.id === workId);
            if (!work) return;
            
            const newPrice = prompt('Enter new price:', work.price);
            if (newPrice && !isNaN(newPrice)) {
                work.price = parseFloat(newPrice);
                saveWorks();
                loadWorksTable();
                showNotification('notification-add', 'Work updated successfully', 'success');
            }
        }
        
        function deleteWork(workId) {
            if (confirm('Are you sure you want to delete this work entry?')) {
                works = works.filter(w => w.id !== workId);
                saveWorks();
                loadWorksTable();
                loadDashboard();
                showNotification('notification-add', 'Work entry deleted', 'success');
            }
        }
        
        function toggleWorkStatus(workId) {
            const work = works.find(w => w.id === workId);
            if (!work) return;
            
            work.status = work.status === 'pending' ? 'completed' : 'pending';
            saveWorks();
            loadWorksTable();
            loadDashboard();
            showNotification('notification-add', `Work marked as ${work.status}`, 'success');
        }
        
        function exportWorksPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('Stone Engraving Works Report', 20, 20);
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
            doc.text(`Total Works: ${works.length}`, 20, 38);
            
            const tableColumn = ["Date", "Retailer", "Customer", "Size", "Photo", "Price", "Status"];
            const tableRows = [];
            
            works.forEach(work => {
                const retailer = retailers.find(r => r.id === work.retailerId);
                const retailerName = retailer ? retailer.name : 'Unknown';
                
                tableRows.push([
                    formatDate(work.date),
                    retailerName,
                    work.customerName + (work.fatherName ? ` (${work.fatherName})` : ''),
                    formatSizeName(work.size),
                    work.photo === 'with' ? 'With' : 'Without',
                    systemSettings.currencySymbol + work.price.toFixed(2),
                    work.status.charAt(0).toUpperCase() + work.status.slice(1)
                ]);
            });
            
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 45,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [220, 20, 60] }
            });
            
            doc.save(`works-report-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('notification-add', 'PDF exported successfully', 'success');
        }
        
        // ==================== RETAILER FUNCTIONS ====================
        function loadRetailerList() {
            const container = document.getElementById('retailer-list');
            container.innerHTML = '';
            
            if (retailers.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);">No retailers found</div>';
                return;
            }
            
            retailers.forEach(retailer => {
                const card = document.createElement('div');
                card.className = 'retailer-card';
                card.style.cssText = `
                    background: white;
                    border-radius: 10px;
                    padding: 20px;
                    margin-bottom: 15px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                    border-left: 4px solid var(--primary);
                `;
                
                const retailerWorks = works.filter(w => w.retailerId === retailer.id);
                const totalBusiness = retailerWorks.reduce((sum, work) => sum + work.price, 0);
                const pendingBills = retailerWorks.filter(w => w.status === 'pending').length;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: var(--secondary); margin-bottom: 5px;">${retailer.name}</h4>
                            <p style="color: var(--text-light); font-size: 0.9rem;">${retailer.contact}</p>
                        </div>
                        <span style="background-color: rgba(220, 20, 60, 0.1); color: var(--primary); padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">
                            ${retailerWorks.length} works
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Total Business</div>
                            <div style="font-weight: 600; color: var(--success);">${systemSettings.currencySymbol}${totalBusiness.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Pending Bills</div>
                            <div style="font-weight: 600; color: ${pendingBills > 0 ? 'var(--danger)' : 'var(--success)'};">${pendingBills}</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" style="padding: 8px 15px; font-size: 0.9rem;" onclick="editRetailer('${retailer.id}')">
                            <span>‚úèÔ∏è</span> Edit
                        </button>
                        <button class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem;" onclick="deleteRetailer('${retailer.id}')">
                            <span>üóëÔ∏è</span> Delete
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function editRetailer(retailerId) {
            const retailer = retailers.find(r => r.id === retailerId);
            if (!retailer) return;
            
            // Fill form
            document.getElementById('retailer-id').value = retailer.id;
            document.getElementById('retailer-name').value = retailer.name;
            document.getElementById('retailer-contact').value = retailer.contact;
            document.getElementById('retailer-email').value = retailer.email || '';
            
            // Fill prices
            document.getElementById('price-12x12').value = retailer.prices['12x12'] || '';
            document.getElementById('price-12x18').value = retailer.prices['12x18'] || '';
            document.getElementById('price-12x30').value = retailer.prices['12x30'] || '';
            document.getElementById('price-12x30-kaman').value = retailer.prices['12x30-kaman'] || '';
            document.getElementById('price-12x24-kaman').value = retailer.prices['12x24-kaman'] || '';
            document.getElementById('photo-with').value = retailer.prices['photo-with'] || '';
            document.getElementById('photo-without').value = retailer.prices['photo-without'] || '';
            
            // Update button
            document.getElementById('retailer-submit-btn').innerHTML = '<span>üíæ</span> Update Retailer';
            
            // Scroll to form
            document.getElementById('retailer-form').scrollIntoView({ behavior: 'smooth' });
            
            showNotification('notification-retailer', `Editing ${retailer.name}`, 'info');
        }
        
        function deleteRetailer(retailerId) {
            const retailer = retailers.find(r => r.id === retailerId);
            if (!retailer) return;
            
            const retailerWorks = works.filter(w => w.retailerId === retailerId);
            
            if (retailerWorks.length > 0) {
                if (!confirm(`This retailer has ${retailerWorks.length} work entries. Delete anyway?`)) {
                    return;
                }
            }
            
            if (confirm(`Are you sure you want to delete ${retailer.name}?`)) {
                retailers = retailers.filter(r => r.id !== retailerId);
                saveRetailers();
                loadRetailerList();
                updateRetailerDropdowns();
                loadDashboard();
                showNotification('notification-retailer', 'Retailer deleted', 'success');
            }
        }
        
        function clearRetailerForm() {
            document.getElementById('retailer-form').reset();
            document.getElementById('retailer-id').value = '';
            document.getElementById('retailer-submit-btn').innerHTML = '<span>‚ûï</span> Add Retailer';
        }
        
        function updateRetailerDropdowns() {
            // Update all retailer dropdowns
            ['retailer', 'filter-retailer', 'select-retailer-bills'].forEach(dropdownId => {
                updateRetailerDropdown(dropdownId);
            });
        }
        
        function updateRetailerDropdown(dropdownId) {
            const select = document.getElementById(dropdownId);
            if (!select) return;
            
            const currentValue = select.value;
            
            // Clear options (keep first option)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Add retailer options
            retailers.forEach(retailer => {
                const option = document.createElement('option');
                option.value = retailer.id;
                option.textContent = retailer.name;
                select.appendChild(option);
            });
            
            // Restore previous value if possible
            if (retailers.some(r => r.id === currentValue)) {
                select.value = currentValue;
            }
        }
        
        // ==================== WHATSAPP BILLS FUNCTIONS ====================
        function loadRetailerBills() {
            const retailerId = document.getElementById('select-retailer-bills').value;
            if (!retailerId) {
                document.getElementById('bills-summary').innerHTML = `
                    <h4 style="color: var(--secondary); margin-bottom: 15px; font-size: 1.3rem;">Bill Summary</h4>
                    <p style="color: var(--text-light);">Select a retailer to view pending bills</p>
                `;
                updateWhatsAppPreview();
                return;
            }
            
            const retailer = retailers.find(r => r.id === retailerId);
            if (!retailer) return;
            
            const pendingWorks = works.filter(w => w.retailerId === retailerId && w.status === 'pending');
            const totalAmount = pendingWorks.reduce((sum, work) => sum + work.price, 0);
            
            let summaryHTML = `
                <h4 style="color: var(--secondary); margin-bottom: 10px;">${retailer.name} - Pending Bills</h4>
                <p style="color: var(--text-light);">Contact: ${retailer.contact}</p>
                <p><strong>Total Pending Works:</strong> ${pendingWorks.length}</p>
                <p><strong>Total Amount Due:</strong> <span style="color: var(--danger); font-weight: 700;">${systemSettings.currencySymbol}${totalAmount.toFixed(2)}</span></p>
            `;
            
            if (pendingWorks.length > 0) {
                summaryHTML += `<div style="margin-top: 15px; max-height: 200px; overflow-y: auto;">`;
                pendingWorks.forEach((work, index) => {
                    summaryHTML += `
                        <div style="padding: 8px; border-bottom: 1px solid var(--medium-gray); font-size: 0.9rem;">
                            ${index + 1}. ${work.customerName}${work.fatherName ? ` (${work.fatherName})` : ''} - ${formatSizeName(work.size)} (${work.photo === 'with' ? 'With Photo' : 'Without Photo'}) - ${systemSettings.currencySymbol}${work.price.toFixed(2)}
                        </div>
                    `;
                });
                summaryHTML += `</div>`;
            } else {
                summaryHTML += `<p style="color: var(--success); margin-top: 15px; font-weight: 700;">No pending bills for this retailer.</p>`;
            }
            
            document.getElementById('bills-summary').innerHTML = summaryHTML;
            updateWhatsAppPreview();
        }
        
        function updateWhatsAppPreview() {
            const retailerId = document.getElementById('select-retailer-bills').value;
            if (!retailerId) {
                document.getElementById('whatsapp-preview').innerHTML = 'Select a retailer to preview WhatsApp message';
                return;
            }
            
            const retailer = retailers.find(r => r.id === retailerId);
            if (!retailer) return;
            
            const pendingWorks = works.filter(w => w.retailerId === retailerId && w.status === 'pending');
            const totalAmount = pendingWorks.reduce((sum, work) => sum + work.price, 0);
            const customMessage = document.getElementById('custom-message').value.trim();
            
            let message = `Hello ${retailer.name},\n\n`;
            message += `Here is your pending bill summary from Stone Engraving Co.:\n\n`;
            
            if (pendingWorks.length > 0) {
                message += `*Pending Bills Summary:*\n`;
                pendingWorks.forEach((work, index) => {
                    message += `${index + 1}. ${work.customerName}${work.fatherName ? ` (${work.fatherName})` : ''} - ${formatSizeName(work.size)} (${work.photo === 'with' ? 'With Photo' : 'Without Photo'}) - ${systemSettings.currencySymbol}${work.price.toFixed(2)}\n`;
                });
                
                message += `\n*Total Amount Due: ${systemSettings.currencySymbol}${totalAmount.toFixed(2)}*\n\n`;
                message += `Please make the payment at your earliest convenience.\n`;
            } else {
                message += `You have no pending bills at the moment.\n`;
                message += `Thank you for your business!\n`;
            }
            
            if (customMessage) {
                message += `\nNote: ${customMessage}\n`;
            }
            
            message += `\nBest regards,\nStone Engraving Co.`;
            
            document.getElementById('whatsapp-preview').innerHTML = message.replace(/\n/g, '<br>').replace(/\*/g, '<strong>').replace(/\*/g, '</strong>');
        }
        
        function sendWhatsAppBill() {
            const retailerId = document.getElementById('select-retailer-bills').value;
            if (!retailerId) {
                showNotification('notification-whatsapp', 'Please select a retailer first', 'error');
                return;
            }
            
            const retailer = retailers.find(r => r.id === retailerId);
            if (!retailer) return;
            
            const pendingWorks = works.filter(w => w.retailerId === retailerId && w.status === 'pending');
            if (pendingWorks.length === 0) {
                showNotification('notification-whatsapp', 'No pending bills for this retailer', 'error');
                return;
            }
            
            // Generate message
            let message = `Hello ${retailer.name},\n\n`;
            message += `Here is your pending bill summary from Stone Engraving Co.:\n\n`;
            
            pendingWorks.forEach((work, index) => {
                message += `${index + 1}. ${work.customerName}${work.fatherName ? ` (${work.fatherName})` : ''} - ${formatSizeName(work.size)} (${work.photo === 'with' ? 'With Photo' : 'Without Photo'}) - ${systemSettings.currencySymbol}${work.price.toFixed(2)}\n`;
            });
            
            const totalAmount = pendingWorks.reduce((sum, work) => sum + work.price, 0);
            message += `\nTotal Amount Due: ${systemSettings.currencySymbol}${totalAmount.toFixed(2)}\n\n`;
            
            const customMessage = document.getElementById('custom-message').value.trim();
            if (customMessage) {
                message += `Note: ${customMessage}\n\n`;
            }
            
            message += `Please make the payment at your earliest convenience.\n\n`;
            message += `Best regards,\nStone Engraving Co.`;
            
            // Encode for WhatsApp URL
            const encodedMessage = encodeURIComponent(message);
            const phoneNumber = retailer.contact.replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            // Open in new tab
            window.open(whatsappUrl, '_blank');
            
            showNotification('notification-whatsapp', 'WhatsApp bill sent!', 'success');
        }
        
        function markAllAsPaid() {
            const retailerId = document.getElementById('select-retailer-bills').value;
            if (!retailerId) {
                showNotification('notification-whatsapp', 'Please select a retailer first', 'error');
                return;
            }
            
            if (!confirm('Mark all pending bills for this retailer as paid?')) {
                return;
            }
            
            let updatedCount = 0;
            works.forEach(work => {
                if (work.retailerId === retailerId && work.status === 'pending') {
                    work.status = 'completed';
                    updatedCount++;
                }
            });
            
            saveWorks();
            loadRetailerBills();
            loadDashboard();
            
            showNotification('notification-whatsapp', `${updatedCount} bills marked as paid`, 'success');
        }
        
        // ==================== PHONE NUMBERS FUNCTIONS ====================
        function loadPhoneNumbers() {
            const container = document.getElementById('phone-numbers-list');
            const countElement = document.getElementById('phone-count');
            
            container.innerHTML = '';
            countElement.textContent = phoneNumbers.length;
            
            if (phoneNumbers.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);">No phone numbers saved yet</div>';
                return;
            }
            
            phoneNumbers.forEach((phone, index) => {
                const div = document.createElement('div');
                div.className = 'phone-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight: 700; color: var(--secondary);">${phone.number}</div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">
                            <span style="background-color: rgba(220, 20, 60, 0.1); padding: 3px 10px; border-radius: 12px; margin-right: 10px; color: var(--primary);">${phone.category}</span>
                            ${phone.notes ? phone.notes : ''}
                        </div>
                    </div>
                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.85rem;" onclick="removePhoneNumber(${index})">
                        <span>üóëÔ∏è</span>
                    </button>
                `;
                container.appendChild(div);
            });
        }
        
        function addPhoneNumber() {
            const numberInput = document.getElementById('new-phone');
            const categorySelect = document.getElementById('phone-category');
            const notesInput = document.getElementById('phone-notes');
            
            const number = numberInput.value.trim();
            if (!number) {
                showNotification('notification-whatsapp', 'Please enter a phone number', 'error');
                return;
            }
            
            // Basic validation
            const phoneRegex = /^[+]?[0-9\s\-\(\)]{10,}$/;
            if (!phoneRegex.test(number)) {
                showNotification('notification-whatsapp', 'Please enter a valid phone number', 'error');
                return;
            }
            
            const newPhone = {
                id: 'phone-' + Date.now(),
                number: number,
                category: categorySelect.value,
                notes: notesInput.value.trim(),
                dateAdded: new Date().toISOString()
            };
            
            phoneNumbers.push(newPhone);
            savePhoneNumbers();
            loadPhoneNumbers();
            
            // Clear inputs
            numberInput.value = '';
            notesInput.value = '';
            
            // Show success
            document.getElementById('export-status').textContent = 'Number added successfully!';
            document.getElementById('export-status').style.color = 'var(--success)';
            setTimeout(() => {
                document.getElementById('export-status').textContent = '';
            }, 3000);
        }
        
        function removePhoneNumber(index) {
            if (confirm('Remove this phone number?')) {
                phoneNumbers.splice(index, 1);
                savePhoneNumbers();
                loadPhoneNumbers();
            }
        }
        
        function clearAllPhoneNumbers() {
            if (phoneNumbers.length === 0) return;
            
            if (confirm('Are you sure you want to delete ALL phone numbers? This cannot be undone.')) {
                phoneNumbers = [];
                savePhoneNumbers();
                loadPhoneNumbers();
                showNotification('notification-whatsapp', 'All phone numbers cleared', 'success');
            }
        }
        
        function exportPhoneNumbersPDF() {
            if (phoneNumbers.length === 0) {
                showNotification('notification-whatsapp', 'No phone numbers to export', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('Phone Numbers Directory', 20, 20);
            doc.setFontSize(12);
            doc.text(`Total Numbers: ${phoneNumbers.length}`, 20, 30);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 38);
            
            const tableColumn = ["#", "Phone Number", "Category", "Notes", "Date Added"];
            const tableRows = [];
            
            phoneNumbers.forEach((phone, index) => {
                tableRows.push([
                    index + 1,
                    phone.number,
                    phone.category,
                    phone.notes || '-',
                    new Date(phone.dateAdded).toLocaleDateString()
                ]);
            });
            
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 45,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [220, 20, 60] }
            });
            
            doc.save(`phone-numbers-${new Date().toISOString().split('T')[0]}.pdf`);
            
            document.getElementById('export-status').textContent = 'PDF exported successfully!';
            document.getElementById('export-status').style.color = 'var(--success)';
            setTimeout(() => {
                document.getElementById('export-status').textContent = '';
            }, 3000);
        }
        
        function exportHundredNumbersPDF() {
            if (phoneNumbers.length === 0) {
                showNotification('notification-whatsapp', 'No phone numbers to export', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            let startIndex = 0;
            
            // Get last export index
            const lastExportIndex = parseInt(localStorage.getItem('last-export-index') || '0');
            startIndex = lastExportIndex;
            
            // Get next 100 numbers
            const endIndex = Math.min(startIndex + 100, phoneNumbers.length);
            const exportNumbers = phoneNumbers.slice(startIndex, endIndex);
            
            if (exportNumbers.length === 0) {
                // Reset to beginning
                startIndex = 0;
                localStorage.setItem('last-export-index', '0');
                exportHundredNumbersPDF(); // Recursive call
                return;
            }
            
            // Create PDF
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text('Phone Numbers (Batch Export)', 20, 20);
            doc.setFontSize(12);
            doc.text(`Numbers ${startIndex + 1} to ${endIndex} of ${phoneNumbers.length}`, 20, 30);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 38);
            
            const tableColumn = ["#", "Phone Number", "Category", "Notes"];
            const tableRows = [];
            
            exportNumbers.forEach((phone, index) => {
                tableRows.push([
                    startIndex + index + 1,
                    phone.number,
                    phone.category,
                    phone.notes || '-'
                ]);
            });
            
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 45,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [220, 20, 60] }
            });
            
            doc.save(`phone-numbers-batch-${startIndex + 1}-to-${endIndex}.pdf`);
            
            // Update index for next export
            const nextIndex = endIndex >= phoneNumbers.length ? 0 : endIndex;
            localStorage.setItem('last-export-index', nextIndex.toString());
            
            document.getElementById('export-status').textContent = 
                `Exported numbers ${startIndex + 1}-${endIndex}. Next batch: ${nextIndex + 1}`;
            document.getElementById('export-status').style.color = 'var(--success)';
            setTimeout(() => {
                document.getElementById('export-status').textContent = '';
            }, 5000);
        }
        
        // ==================== SETTINGS FUNCTIONS ====================
        function saveSystemSettings() {
            systemSettings.systemName = document.getElementById('system-name').value;
            systemSettings.currencySymbol = document.getElementById('currency-symbol').value;
            systemSettings.dateFormat = document.getElementById('date-format').value;
            systemSettings.duplicateDays = parseInt(document.getElementById('duplicate-days').value) || 7;
            
            saveSystemSettingsToStorage();
            
            // Update UI
            document.querySelector('.logo').textContent = systemSettings.systemName;
            
            showNotification('notification-whatsapp', 'Settings saved successfully', 'success');
        }
        
        function updateSystemInfo() {
            // Calculate data size
            const worksSize = JSON.stringify(works).length;
            const retailersSize = JSON.stringify(retailers).length;
            const phonesSize = JSON.stringify(phoneNumbers).length;
            const settingsSize = JSON.stringify(systemSettings).length;
            const totalSize = worksSize + retailersSize + phonesSize + settingsSize;
            
            document.getElementById('data-size').textContent = Math.ceil(totalSize / 1024) + ' KB';
            document.getElementById('last-backup').textContent = 
                systemSettings.lastBackup ? new Date(systemSettings.lastBackup).toLocaleDateString() : 'Never';
            document.getElementById('storage-mode-display').textContent = 
                usingFirebase ? 'Firebase Cloud' : 'Local Storage';
        }
        
        function exportAllData() {
            const allData = {
                works: works,
                retailers: retailers,
                phoneNumbers: phoneNumbers,
                settings: systemSettings,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `engraving-backup-${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Update last backup
            systemSettings.lastBackup = new Date().toISOString();
            saveSystemSettingsToStorage();
            updateSystemInfo();
            
            showNotification('notification-whatsapp', 'All data exported successfully', 'success');
        }
        
        function resetSystem() {
            if (!confirm('WARNING: This will reset ALL data to factory settings. Are you absolutely sure?')) {
                return;
            }
            
            if (!confirm('This action cannot be undone. Type "RESET" to confirm:')) {
                return;
            }
            
            // Clear all data
            localStorage.clear();
            
            // Reset variables
            works = [];
            retailers = [];
            phoneNumbers = [];
            systemSettings = {
                systemName: "Stone Engraving Management System",
                currencySymbol: "$",
                dateFormat: "yyyy-mm-dd",
                duplicateDays: 7,
                autoBackup: "weekly",
                lastBackup: null,
                useFirebase: false,
                firebaseConfig: null
            };
            
            // Save default settings
            saveSystemSettingsToStorage();
            
            // Reload page
            alert('System reset complete. Page will reload.');
            location.reload();
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function formatDate(dateString) {
            const date = new Date(dateString);
            switch(systemSettings.dateFormat) {
                case 'dd/mm/yyyy':
                    return date.toLocaleDateString('en-GB');
                case 'mm/dd/yyyy':
                    return date.toLocaleDateString('en-US');
                default:
                    return date.toISOString().split('T')[0];
            }
        }
        
        function formatSizeName(size) {
            const sizeMap = {
                '12x12': '12x12',
                '12x18': '12x18',
                '12x30': '12x30',
                '12x30-kaman': '12x30 Urdu Kaman',
                '12x24-kaman': '12x24 Urdu Kaman'
            };
            return sizeMap[size] || size;
        }
        
        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Work form submission
            document.getElementById('work-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate required fields
                const retailerId = document.getElementById('retailer').value;
                const customerName = document.getElementById('customer-name').value.trim();
                const size = document.getElementById('selected-size').value;
                const price = document.getElementById('price').value;
                
                if (!retailerId || !customerName || !size || !price) {
                    showNotification('notification-add', 'Please fill all required fields', 'error');
                    return;
                }
                
                // Check for duplicate
                const hasDuplicate = checkDuplicateCustomer();
                if (hasDuplicate && !document.getElementById('father-name').value.trim()) {
                    showNotification('notification-add', 'Father/Husband name is required for duplicate customer names', 'error');
                    return;
                }
                
                // Create work object
                const newWork = {
                    id: 'work-' + Date.now(),
                    date: document.getElementById('work-date').value.split('T')[0],
                    datetime: document.getElementById('work-date').value,
                    retailerId: retailerId,
                    customerName: customerName,
                    customerPhone: document.getElementById('customer-phone').value.trim(),
                    fatherName: hasDuplicate ? document.getElementById('father-name').value.trim() : '',
                    size: size,
                    photo: document.querySelector('input[name="photo"]:checked').value,
                    notes: document.getElementById('notes').value.trim(),
                    price: parseFloat(price),
                    status: 'pending'
                };
                
                // Add to works
                works.push(newWork);
                saveWorks();
                
                // Clear form
                initWorkForm();
                
                // Show success
                showNotification('notification-add', 'Work entry added successfully!', 'success');
                
                // Update dashboard if open
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadDashboard();
                }
            });
            
            // Retailer form submission
            document.getElementById('retailer-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form values
                const retailerId = document.getElementById('retailer-id').value;
                const name = document.getElementById('retailer-name').value.trim();
                const contact = document.getElementById('retailer-contact').value.trim();
                const email = document.getElementById('retailer-email').value.trim();
                
                // Validate
                if (!name || !contact) {
                    showNotification('notification-retailer', 'Please fill all required fields', 'error');
                    return;
                }
                
                // Get prices
                const prices = {
                    '12x12': parseFloat(document.getElementById('price-12x12').value) || 0,
                    '12x18': parseFloat(document.getElementById('price-12x18').value) || 0,
                    '12x30': parseFloat(document.getElementById('price-12x30').value) || 0,
                    '12x30-kaman': parseFloat(document.getElementById('price-12x30-kaman').value) || 0,
                    '12x24-kaman': parseFloat(document.getElementById('price-12x24-kaman').value) || 0,
                    'photo-with': parseFloat(document.getElementById('photo-with').value) || 0,
                    'photo-without': parseFloat(document.getElementById('photo-without').value) || 0
                };
                
                // Validate prices
                for (const key in prices) {
                    if (isNaN(prices[key]) || prices[key] < 0) {
                        showNotification('notification-retailer', 'Please enter valid prices', 'error');
                        return;
                    }
                }
                
                if (retailerId) {
                    // Update existing retailer
                    const index = retailers.findIndex(r => r.id === retailerId);
                    if (index !== -1) {
                        retailers[index] = {
                            ...retailers[index],
                            name,
                            contact,
                            email,
                            prices
                        };
                    }
                } else {
                    // Add new retailer
                    const newRetailer = {
                        id: 'retailer-' + Date.now(),
                        name,
                        contact,
                        email,
                        prices
                    };
                    retailers.push(newRetailer);
                }
                
                saveRetailers();
                loadRetailerList();
                updateRetailerDropdowns();
                clearRetailerForm();
                
                showNotification('notification-retailer', `Retailer ${retailerId ? 'updated' : 'added'} successfully!`, 'success');
            });
            
            // Button click events
            document.getElementById('clear-work-form').addEventListener('click', initWorkForm);
            document.getElementById('clear-retailer-form').addEventListener('click', clearRetailerForm);
            document.getElementById('export-works-pdf').addEventListener('click', exportWorksPDF);
            document.getElementById('send-whatsapp-bill').addEventListener('click', sendWhatsAppBill);
            document.getElementById('mark-all-paid').addEventListener('click', markAllAsPaid);
            document.getElementById('add-phone-btn').addEventListener('click', addPhoneNumber);
            document.getElementById('export-all-phones').addEventListener('click', exportPhoneNumbersPDF);
            document.getElementById('export-100-phones').addEventListener('click', exportHundredNumbersPDF);
            document.getElementById('clear-all-phones').addEventListener('click', clearAllPhoneNumbers);
            document.getElementById('save-settings').addEventListener('click', saveSystemSettings);
            document.getElementById('connect-firebase').addEventListener('click', connectToFirebase);
            document.getElementById('test-firebase').addEventListener('click', testFirebaseConnection);
            document.getElementById('disconnect-firebase').addEventListener('click', disconnectFromFirebase);
            document.getElementById('sync-to-firebase').addEventListener('click', syncToFirebase);
            document.getElementById('sync-from-firebase').addEventListener('click', syncFromFirebase);
            document.getElementById('export-all-data').addEventListener('click', exportAllData);
            document.getElementById('reset-system').addEventListener('click', resetSystem);
            
            // Real-time updates for price calculation
            document.getElementById('retailer').addEventListener('change', updatePrice);
            document.getElementById('customer-name').addEventListener('input', checkDuplicateCustomer);
            document.querySelectorAll('input[name="photo"]').forEach(radio => {
                radio.addEventListener('change', updatePrice);
            });
            
            // Filter changes
            document.getElementById('filter-retailer').addEventListener('change', filterWorks);
            document.getElementById('filter-status').addEventListener('change', filterWorks);
            document.getElementById('select-retailer-bills').addEventListener('change', loadRetailerBills);
            document.getElementById('custom-message').addEventListener('input', updateWhatsAppPreview);
        }
    </script>
</body>
</html>